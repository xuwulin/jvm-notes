# JVM å†…å­˜ç»“æ„

Java è™šæ‹Ÿæœºçš„å†…å­˜ç©ºé—´åˆ†ä¸º 5 ä¸ªéƒ¨åˆ†ï¼š

* ç¨‹åºè®¡æ•°å™¨
* Java è™šæ‹Ÿæœºæ ˆ
* æœ¬åœ°æ–¹æ³•æ ˆ
* å †
* æ–¹æ³•åŒº

![jvm-memory-structure](/images/jvm-memory-structure.jpg)

![jvm-memory-structure2](/images/jvm-memory-structure2.png)

JDK 1.8 åŒ JDK 1.7 æ¯”ï¼Œ**æœ€å¤§çš„å·®åˆ«å°±æ˜¯**ï¼š==å…ƒæ•°æ®åŒºï¼ˆå…ƒç©ºé—´ï¼‰å–ä»£äº†æ°¸ä¹…ä»£==ã€‚å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹ JVM è§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒæ•°æ®ç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚

JVMåŒ…å«äºJREã€‚

æ•°æ®ã€æŒ‡ä»¤ã€æ§åˆ¶

**å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£çš„åŒºåˆ«ï¼š**

å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œå› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚

## ç¨‹åºè®¡æ•°å™¨ï¼ˆPC å¯„å­˜å™¨ï¼‰

### ç¨‹åºè®¡æ•°å™¨çš„å®šä¹‰

ç¨‹åºè®¡æ•°å™¨ï¼ˆPrograme Counter Registerï¼‰æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œæ˜¯å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„é‚£æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ã€‚è‹¥å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼ˆNativeï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶ç¨‹åºè®¡æ•°å™¨ä¸º`Undefined`ã€‚

### ç¨‹åºè®¡æ•°å™¨çš„ä½œç”¨

* å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨æ¥ä¾æ¬¡è¯»å–æŒ‡ä»¤ï¼Œä»è€Œå®ç°ä»£ç çš„æµç¨‹æ§åˆ¶ã€‚
* åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ˜¯å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œä»è€Œå½“çº¿ç¨‹åˆ‡æ¢å›æ¥æ—¶ï¼Œå°±çŸ¥é“ä¸Šæ¬¡çº¿ç¨‹æ‰§è¡Œåˆ°å“ªäº†ã€‚

### ç¨‹åºè®¡æ•°å™¨çš„ç‰¹ç‚¹

* æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ã€‚
* **==çº¿ç¨‹ç§æœ‰==**ï¼Œæ¯æ¡çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ã€‚
* ç”Ÿå‘½å‘¨æœŸï¼šéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„ç»“æŸè€Œé”€æ¯ã€‚
* æ˜¯å”¯ä¸€ä¸€ä¸ªä¸ä¼šå‡ºç°`OutOfMemoryError`çš„å†…å­˜åŒºåŸŸã€‚

## Java è™šæ‹Ÿæœºæ ˆï¼ˆJava æ ˆï¼‰

### Java è™šæ‹Ÿæœºæ ˆçš„å®šä¹‰

æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„â€æ ˆâ€œï¼Œå°±æ˜¯æŒ‡javaçš„è™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stacksï¼‰ï¼Œæˆ–è€…è¯´æ˜¯è™šæ‹Ÿæœºæ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨éƒ¨åˆ†ã€‚

Java è™šæ‹Ÿæœºæ ˆæ˜¯æè¿° Java æ–¹æ³•è¿è¡Œè¿‡ç¨‹çš„å†…å­˜æ¨¡å‹ã€‚

Java è™šæ‹Ÿæœºæ ˆä¼šä¸º**æ¯ä¸€ä¸ªå³å°†è¿è¡Œçš„ Java æ–¹æ³•**åˆ›å»ºä¸€å—å«åšâ€œæ ˆå¸§â€ï¼ˆStack Frameï¼‰çš„åŒºåŸŸï¼ˆæ ˆå¸§æ˜¯æ–¹æ³•è¿è¡Œæ—¶çš„åŸºç¡€æ•°æ®ç»“æ„ï¼Œæ ˆå¸§ä¹Ÿå«è¿‡ç¨‹æ´»åŠ¨è®°å½•ï¼‰ï¼Œç”¨äºå­˜æ”¾è¯¥æ–¹æ³•è¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›ä¿¡æ¯ï¼Œå¦‚ï¼š

è¿è¡Œæ—¶æ ˆå¸§ç»“æ„ï¼š

* å±€éƒ¨å˜é‡è¡¨ï¼ˆæˆ‘ä»¬å¸¸è¯´çš„Javaè™šæ‹Ÿæœºæ ˆå°±æ˜¯æŒ‡æ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨ï¼‰
* æ“ä½œæ•°æ ˆ
* åŠ¨æ€é“¾æ¥
* æ–¹æ³•å‡ºå£ï¼ˆè¿”å›åœ°å€ï¼‰ä¿¡æ¯ï¼šæ–¹æ³•è°ƒç”¨æ—¶é€šè¿‡ä¸€ä¸ªæŒ‡å‘æ–¹æ³•çš„æŒ‡é’ˆæŒ‡å‘æ–¹æ³•çš„åœ°å€ï¼Œæ–¹æ³•è¿”å›æ—¶å°†å›å½’åˆ°è°ƒç”¨å¤„ï¼Œé‚£ä¸ªåœ°æ–¹æ—¶è¿”å›åœ°å€
* ......

![jvm-stack](/images/jvm-stack.jpg)

æ ˆå¸§ä¹Ÿå«è¿‡ç¨‹æ´»åŠ¨è®°å½•ï¼Œæ˜¯ç¼–è¯‘å™¨ç”¨æ¥è¿›è¡Œæ–¹æ³•è°ƒç”¨å’Œæ–¹æ³•æ‰§è¡Œçš„ä¸€ç§**æ•°æ®ç»“æ„**ï¼Œä»–æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºä¸­çš„è™šæ‹Ÿæœºæ ˆçš„æ ˆå…ƒç´ ã€‚æ ˆå¸§ä¸­åŒ…æ‹¬äº†å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥å’Œæ–¹æ³•è¿”å›åœ°å€ä»¥åŠé¢å¤–çš„ä¸€äº›é™„åŠ ä¿¡æ¯ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå±€éƒ¨å˜é‡è¡¨çš„å¤§å°å·²ç»ç¡®å®šï¼Œæ“ä½œæ•°æ ˆæ·±åº¦ä¹Ÿå·²ç»ç¡®å®šï¼Œå› æ­¤æ ˆå¸§åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­éœ€è¦åˆ†é…å¤šå¤§çš„å†…å­˜æ˜¯å›ºå®šçš„ï¼Œä¸å—è¿è¡Œæ—¶å½±å“ã€‚å¯¹äºæ²¡æœ‰é€ƒé€¸çš„å¯¹è±¡ä¹Ÿä¼šåœ¨æ ˆä¸Šåˆ†é…ï¼Œå¯¹è±¡çš„å¤§å°å…¶å®åœ¨è¿è¡Œæ—¶ä¹Ÿæ˜¯ç¡®å®šçš„ï¼Œå› æ­¤å³ä½¿å‡ºç°äº†æ ˆä¸Šå†…å­˜åˆ†é…ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æ ˆå¸§æ”¹å˜å¤§å°ã€‚

ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œè‚¯è°ƒç”¨é“¾ä¼šå¾ˆé•¿ï¼Œå¾ˆå¤šæ–¹æ³•éƒ½åŒæ—¶å¤„äºæ‰§è¡ŒçŠ¶æ€ã€‚å¯¹äºæ‰§è¡Œå¼•æ“æ¥è®²ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œåªæœ‰æ ˆé¡¶çš„æ ˆå¸§æ˜¯æœ‰æ•ˆçš„ï¼Œç§°ä¸ºå½“å‰æ ˆå¸§ï¼Œè¿™ä¸ªæ ˆå¸§æ‰€å…³è”çš„æ–¹æ³•ç§°ä¸ºå½“å‰æ–¹æ³•ã€‚æ‰§è¡Œå¼•æ“æ‰€è¿è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤å¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚

### å‹æ ˆå‡ºæ ˆè¿‡ç¨‹

å½“æ–¹æ³•è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦åˆ›å»ºå±€éƒ¨å˜é‡æ—¶ï¼Œå°±å°†å±€éƒ¨å˜é‡çš„å€¼å­˜å…¥æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­ã€‚

Java è™šæ‹Ÿæœºæ ˆçš„æ ˆé¡¶çš„æ ˆå¸§æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ´»åŠ¨æ ˆï¼Œä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•ï¼ŒPC å¯„å­˜å™¨ä¹Ÿä¼šæŒ‡å‘è¿™ä¸ªåœ°å€ã€‚åªæœ‰è¿™ä¸ªæ´»åŠ¨çš„æ ˆå¸§çš„æœ¬åœ°å˜é‡å¯ä»¥è¢«æ“ä½œæ•°æ ˆä½¿ç”¨ï¼Œå½“åœ¨è¿™ä¸ªæ ˆå¸§ä¸­è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œä¸ä¹‹å¯¹åº”çš„æ ˆå¸§åˆä¼šè¢«åˆ›å»ºï¼Œæ–°åˆ›å»ºçš„æ ˆå¸§å‹å…¥æ ˆé¡¶ï¼Œå˜ä¸ºå½“å‰çš„æ´»åŠ¨æ ˆå¸§ã€‚

æ–¹æ³•ç»“æŸåï¼Œå½“å‰æ ˆå¸§è¢«ç§»å‡ºï¼Œæ ˆå¸§çš„è¿”å›å€¼å˜æˆæ–°çš„æ´»åŠ¨æ ˆå¸§ä¸­æ“ä½œæ•°æ ˆçš„ä¸€ä¸ªæ“ä½œæ•°ã€‚å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œé‚£ä¹ˆæ–°çš„æ´»åŠ¨æ ˆå¸§ä¸­æ“ä½œæ•°æ ˆçš„æ“ä½œæ•°æ²¡æœ‰å˜åŒ–ã€‚

> ç”±äºJava è™šæ‹Ÿæœºæ ˆæ˜¯ä¸çº¿ç¨‹å¯¹åº”çš„ï¼Œæ•°æ®ä¸æ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œå› æ­¤ä¸ç”¨å…³å¿ƒæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨åŒæ­¥é”çš„é—®é¢˜ã€‚

### Java è™šæ‹Ÿæœºæ ˆçš„ç‰¹ç‚¹

* å±€éƒ¨å˜é‡è¡¨å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceç±»å‹ï¼Œå®ƒä¸ç­‰åŒäºå¯¹è±¡æœ¬èº«ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–ä¸æ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰å’ŒreturnAddressç±»å‹ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼‰ï¼Œå…¶ä¸­64ä½é•¿åº¦çš„longå’Œdoubleç±»å‹çš„æ•°æ®ä¼šå ç”¨2ä¸ªå±€éƒ¨å˜é‡ç©ºé—´ï¼ˆSlotï¼‰ï¼Œå…¶ä½™æ•°æ®ç±»å‹åªå ç”¨ä¸€ä¸ªã€‚
* å±€éƒ¨å˜é‡è¡¨éšç€æ ˆå¸§çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œå®ƒçš„**å¤§å°åœ¨ç¼–è¯‘æ—¶ç¡®å®š**ï¼Œåˆ›å»ºæ—¶åªéœ€åˆ†é…äº‹å…ˆè§„å®šçš„å¤§å°å³å¯ã€‚åœ¨æ–¹æ³•è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå±€éƒ¨å˜é‡è¡¨çš„å¤§å°ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚
* Java è™šæ‹Ÿæœºæ ˆä¼šå‡ºç°**ä¸¤ç§å¼‚å¸¸**ï¼šStackOverFlowError å’Œ OutOfMemoryErrorã€‚
  * **StackOverFlowError**ï¼š è‹¥ Java è™šæ‹Ÿæœºæ ˆçš„å¤§å°ä¸å…è®¸åŠ¨æ€æ‰©å±•ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹è¯·æ±‚æ ˆçš„æ·±åº¦è¶…è¿‡å½“å‰ Java è™šæ‹Ÿæœºæ ˆçš„æœ€å¤§æ·±åº¦æ—¶ï¼ŒæŠ›å‡º StackOverFlowError å¼‚å¸¸ã€‚
  * **OutOfMemoryError**ï¼š è‹¥Javaè™šæ‹Ÿæœºæ ˆå…è®¸åŠ¨æ€æ‰©å±•ï¼ˆå½“å‰å¤§éƒ¨åˆ†çš„javaè™šæ‹Ÿæœºæ ˆéƒ½å¯åŠ¨æ€æ‰©å±•ï¼‰ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹è¯·æ±‚æ ˆæ—¶å†…å­˜ç”¨å®Œäº†ï¼ˆæ‰©å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼‰ï¼Œæ— æ³•å†åŠ¨æ€æ‰©å±•æ—¶ï¼ŒæŠ›å‡ºOutOfMemoryError å¼‚å¸¸ã€‚
* Java è™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯==**çº¿ç¨‹ç§æœ‰**==ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒï¼Œéšç€çº¿ç¨‹åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„ç»“æŸè€Œé”€æ¯ã€‚

> å‡ºç° StackOverFlowError æ—¶ï¼Œå†…å­˜ç©ºé—´å¯èƒ½è¿˜æœ‰å¾ˆå¤šã€‚

###  è™šæ‹Ÿæœºæ ˆçš„ä½œç”¨

å­˜å‚¨å½“å‰çº¿ç¨‹è¿è¡Œæ–¹æ³•æ‰€éœ€è¦çš„æ•°æ®ã€æŒ‡ä»¤ã€è¿”å›åœ°å€ã€‚ï¼ˆæ–¹æ³•ç”±çº¿ç¨‹æ‰§è¡Œï¼‰



## æœ¬åœ°æ–¹æ³•æ ˆï¼ˆC æ ˆï¼‰

### æœ¬åœ°æ–¹æ³•æ ˆçš„å®šä¹‰

æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰æ˜¯ä¸º JVM è¿è¡Œ Native æ–¹æ³•å‡†å¤‡çš„ç©ºé—´ï¼Œç”±äºå¾ˆå¤š Native æ–¹æ³•éƒ½æ˜¯ç”¨ C è¯­è¨€å®ç°çš„ï¼Œæ‰€ä»¥å®ƒé€šå¸¸åˆå« C æ ˆã€‚å®ƒä¸ Java è™šæ‹Ÿæœºæ ˆå®ç°çš„åŠŸèƒ½ç±»ä¼¼ï¼Œåªä¸è¿‡æœ¬åœ°æ–¹æ³•æ ˆæ˜¯æè¿°æœ¬åœ°æ–¹æ³•è¿è¡Œè¿‡ç¨‹çš„å†…å­˜æ¨¡å‹ã€‚

æœ¬åœ°æ–¹æ³•æ ˆä¸è™šæ‹Ÿæœºæ ˆå‘æŒ¥çš„ä½œç”¨éå¸¸ç›¸ä¼¼ï¼Œä»–ä»¬ä¹‹é—´çš„**åŒºåˆ«**ä¸è¿‡æ˜¯è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒJavaæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰çš„æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„Nativeæ–¹æ³•æœåŠ¡

### æ ˆå¸§å˜åŒ–è¿‡ç¨‹

æœ¬åœ°æ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œåœ¨æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šåˆ›å»ºä¸€å—æ ˆå¸§ï¼Œç”¨äºå­˜æ”¾è¯¥æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ä¿¡æ¯ç­‰ã€‚

æ–¹æ³•æ‰§è¡Œç»“æŸåï¼Œç›¸åº”çš„æ ˆå¸§ä¹Ÿä¼šå‡ºæ ˆï¼Œå¹¶é‡Šæ”¾å†…å­˜ç©ºé—´ã€‚ä¹Ÿä¼šæŠ›å‡º StackOverFlowError å’Œ OutOfMemoryError å¼‚å¸¸ã€‚

> å¦‚æœ Java è™šæ‹Ÿæœºæœ¬èº«ä¸æ”¯æŒ Native æ–¹æ³•ï¼Œæˆ–æ˜¯æœ¬èº«ä¸ä¾èµ–äºä¼ ç»Ÿæ ˆï¼Œé‚£ä¹ˆå¯ä»¥ä¸æä¾›æœ¬åœ°æ–¹æ³•æ ˆã€‚å¦‚æœæ”¯æŒæœ¬åœ°æ–¹æ³•æ ˆï¼Œé‚£ä¹ˆè¿™ä¸ªæ ˆä¸€èˆ¬ä¼šåœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™æŒ‰çº¿ç¨‹åˆ†é…ã€‚

## å †

### å †çš„å®šä¹‰

Javaå †ï¼ˆJava Heapï¼‰æ˜¯Javaè™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚æ˜¯ç”¨æ¥å­˜æ”¾å¯¹è±¡å®ä¾‹çš„å†…å­˜ç©ºé—´ï¼Œ**==å‡ ä¹==**æ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜å‚¨åœ¨å †ä¸­ã€‚

### å †çš„ç‰¹ç‚¹

* **==çº¿ç¨‹å…±äº«==**ï¼Œæ•´ä¸ª Java è™šæ‹Ÿæœºåªæœ‰ä¸€ä¸ªå †ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½è®¿é—®åŒä¸€ä¸ªå †ã€‚è€Œç¨‹åºè®¡æ•°å™¨ã€Java è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆéƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªã€‚
* **==åœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»º==**ã€‚
* **==æ˜¯åƒåœ¾å›æ”¶çš„ä¸»è¦åœºæ‰€==**ï¼Œå› æ­¤å¾ˆå¤šæ—¶å€™ä¹Ÿè¢«ç§°ä¸ºâ€œGCå †â€ï¼ˆGarabge Collected Heapï¼‰
* ä»å†…å­˜åˆ†é…çš„è§’åº¦æ¥çœ‹ï¼Œç”±äºç°åœ¨æ”¶é›†å™¨åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œæ‰€æœ‰javaå †å¯ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£ï¼ˆYoungï¼‰(Youngåˆè¢«åˆ†ä¸º2ä¸ªéƒ¨åˆ†ï¼ˆä¸€ä¸ªEdenåŒºå’Œä¸¤ä¸ªSurvivorï¼ˆå¹¸å­˜ï¼‰åŒºï¼Œä¸€èˆ¬ç§°s0ã€s1ï¼‰å’Œ3ä¸ªæ¿å—ï¼ŒEdenåŒº  From Survivorã€ To Survivor\)ã€è€å¹´ä»£ã€‚
* ä»å†…å­˜åˆ†é…çš„è§’åº¦æ¥çœ‹ï¼Œçº¿ç¨‹å…±äº«çš„javaå †ä¸­å¯èƒ½åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒºï¼ˆThread Local Allocationï¼ŒTLABï¼‰ï¼Œä¸è¿‡æ— è®ºå¦‚ä½•åˆ’åˆ†ï¼Œéƒ½ä¸å­˜æ”¾å†…å®¹æ— å…³ï¼Œ==æ— è®ºå“ªä¸ªåŒºï¼Œå­˜å‚¨çš„éƒ½æ˜¯å¯¹è±¡å®ä¾‹==ï¼Œè¿›ä¸€æ­¥åˆ’åˆ†çš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½åœ°å›æ”¶å†…å­˜ï¼Œæˆ–è€…æ›´å¿«çš„åˆ†é…å†…å­˜ã€‚

![heap-structure](/images/heap-structure.jpg)

jdk1.8å˜åŒ–ï¼šæ°¸ä¹…ä»£è¢«å…ƒç©ºé—´ï¼ˆMateSpaceå–ä»£ï¼‰

![jdk1.8-heap-structure](/images/jdk1.8-heap-structure.png)

ä¸åŒçš„åŒºåŸŸå­˜æ”¾ä¸åŒç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼Œè¿™æ ·å¯ä»¥æ ¹æ®ä¸åŒçš„åŒºåŸŸä½¿ç”¨ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œæ›´å…·æœ‰é’ˆå¯¹æ€§ã€‚

ä¸‹é¢æ¥å…·ä½“çœ‹ä¸‹ï¼Œ**==æ–°ç”Ÿä»£çš„æ¯éƒ¨åˆ†éƒ½æ˜¯å¹²å•¥çš„==**ï¼š

ï¼ˆ1ï¼‰EdenåŒºåŸŸæ˜¯ç”¨æ¥å­˜æ”¾ä½¿ç”¨newæˆ–è€…newInstanceç­‰æ–¹å¼åˆ›å»ºçš„å¯¹è±¡ï¼Œé»˜è®¤éƒ½æ˜¯å­˜æ”¾åœ¨EdenåŒºï¼Œé™¤éè¿™ä¸ªå¯¹è±¡å¤ªå¤§ï¼Œæˆ–è€…è¶…è¿‡äº†è®¾å®šçš„é˜ˆå€¼-XX:PretenureSizeThresold,è¿™æ ·çš„å¯¹è±¡ä¼šè¢«ç›´æ¥åˆ†é…åˆ°OldåŒºåŸŸã€‚

ï¼ˆ2ï¼‰2ä¸ªSurvivorï¼ˆå¹¸å­˜ï¼‰åŒºï¼Œä¸€èˆ¬ç§°S0ï¼ŒS1ï¼Œç†è®ºä¸Šä»–ä»¬æ˜¯ä¸€æ ·å¤§çš„ï¼Œè§£é‡Šä¸€ä¸‹ï¼Œä»–ä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š           åœ¨ä¸æ–­åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼ŒEdenåŒºä¼šæ»¡ï¼Œè¿™æ—¶å€™ä¼šå¼€å§‹åšYoung Gä¹Ÿå«Minor GCï¼Œè€ŒYoungç©ºé—´çš„ç¬¬ä¸€æ¬¡GCå°±æ˜¯æ‰¾å‡ºEdenåŒºä¸­ï¼Œå¹¸å­˜æ´»ç€çš„å¯¹è±¡ï¼Œç„¶åå°†è¿™äº›å¯¹è±¡ï¼Œæ”¾åˆ°S0ï¼Œæˆ–S1åŒºä¸­çš„å…¶ä¸­ä¸€ä¸ªï¼Œ å‡è®¾ç¬¬ä¸€æ¬¡é€‰æ‹©äº†S0ï¼Œå®ƒä¼šé€æ­¥å°†æ´»ç€çš„å¯¹è±¡æ‹·è´åˆ°S0åŒºåŸŸï¼Œä½†æ˜¯å¦‚æœS0åŒºåŸŸæ»¡äº†ï¼Œå‰©ä¸‹æ´»ç€çš„å¯¹è±¡åªèƒ½æ”¾oldåŒºåŸŸäº†ï¼Œæ¥ä¸‹æ¥è¦åšçš„æ˜¯ï¼Œå°†EdenåŒºåŸŸæ¸…ç©ºï¼Œæ­¤æ—¶S1åŒºåŸŸä¹Ÿæ˜¯ç©ºçš„ã€‚

â€‹    å½“ç¬¬äºŒæ¬¡EdenåŒºåŸŸæ»¡çš„æ—¶å€™ï¼Œå°±å°†EdenåŒºåŸŸä¸­æ´»ç€çš„å¯¹è±¡å’ŒS0åŒºåŸŸä¸­æ´»ç€çš„å¯¹è±¡ï¼Œè¿ç§»åˆ°S1ä¸­ï¼Œå¦‚æœS1æ”¾ä¸ä¸‹ï¼Œå°±ä¼šå°†å‰©ä¸‹çš„å¯¹è±¡ï¼Œæ”¾åˆ°OldåŒºåŸŸä¸­ï¼Œåªæ˜¯è¿™æ¬¡å¯¹è±¡æ¥æºåŒºåŸŸå¢åŠ äº†S0ï¼Œæœ€åä¼šå°†EdenåŒºå’ŒS0åŒºåŸŸæ¸…ç©º

â€‹    ç¬¬ä¸‰æ¬¡å’Œç¬¬å››æ¬¡ä¾æ¬¡ç±»æ¨ï¼Œå§‹ç»ˆä¿è¯S0å’ŒS1æœ‰ä¸€ä¸ªæ˜¯ç©ºçš„ï¼Œç”¨æ¥å­˜å‚¨ä¸´æ—¶å¯¹è±¡ï¼Œç”¨äºäº¤æ¢ç©ºé—´çš„ç›®çš„ï¼Œååå¤å¤å¤šæ¬¡æ²¡æœ‰è¢«æ·˜æ±°çš„å¯¹è±¡ï¼Œå°†ä¼šæ”¾å…¥oldåŒºåŸŸä¸­ï¼Œé»˜è®¤æ˜¯15æ¬¡ã€‚å…·ä½“çš„äº¤æ¢è¿‡ç¨‹å°±å’Œä¸Šå›¾ä¸­çš„ä¿¡æ¯ç›¸ä¼¼ã€‚

```
é—®é¢˜ä¸€ï¼šæ€ä¹ˆå®šä¹‰æ´»ç€çš„å¯¹è±¡ï¼Ÿ
ä»æ ¹å¼•ç”¨å¼€å§‹ï¼Œå¯¹è±¡çš„å†…éƒ¨å±æ€§å¯èƒ½ä¹Ÿæ˜¯å¼•ç”¨ï¼Œåªè¦èƒ½çº§è”åˆ°çš„éƒ½è¢«è®¤ä¸ºæ˜¯æ´»ç€çš„å¯¹è±¡

é—®é¢˜äºŒï¼šä»€ä¹ˆæ˜¯æ ¹ï¼Ÿ
æœ¬åœ°å˜é‡å¼•ç”¨ï¼Œæ“ä½œæ•°æ ˆå¼•ç”¨ï¼ŒPCå¯„å­˜å™¨ï¼Œæœ¬åœ°æ–¹æ³•æ ˆå¼•ç”¨ç­‰è¿™äº›éƒ½æ˜¯æ ¹ã€‚

é—®é¢˜ä¸‰ï¼šå¯¹è±¡è¿›å…¥OldåŒºåŸŸæœ‰ä»€ä¹ˆåå¤„ï¼Ÿ
oldåŒºåŸŸä¸€èˆ¬ç§°ä¸ºè€å¹´ä»£ï¼Œè€å¹´ä»£ä¸æ–°ç”Ÿä»£ä¸ä¸€æ ·ï¼Œæ–°ç”Ÿä»£ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡å¾ˆå°‘ï¼Œè€Œè€å¹´ä»£åˆ™ç›¸åï¼Œå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡å¾ˆå¤šï¼Œæ‰€ä»¥JVMçš„å †å†…å­˜ï¼Œæ‰æ˜¯æˆ‘ä»¬é€šå¸¸å…³æ³¨çš„ä¸»æˆ˜åœºï¼Œå› ä¸ºè¿™é‡Œé¢æ´»ç€çš„å¯¹è±¡éå¸¸å¤šï¼Œæ‰€ä»¥å‘ç”Ÿä¸€æ¬¡FULL GCï¼Œæ¥æ‰¾å‡ºæ¥æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡æ˜¯éå¸¸è€—æ—¶çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…FULL GCçš„å‘ç”Ÿã€‚

é—®é¢˜å››ï¼šS0å’ŒS1ä¸€èˆ¬å¤šå¤§ï¼Œé ä»€ä¹ˆå‚æ•°æ¥æ§åˆ¶ï¼Œæœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ
ä¸€èˆ¬æ¥è¯´å¾ˆå°ï¼Œæˆ‘ä»¬å¤§æ¦‚çŸ¥é“å®ƒä¸Youngå·®ä¸å¤šç›¸å·®ä¸€å€çš„æ¯”ä¾‹ï¼Œè®¾ç½®çš„çš„å‚æ•°ä¸»è¦æœ‰ä¸¤ä¸ªï¼š
-XX:SurvivorRatio=8
-XX:InitialSurvivorRatio=8
ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Edenå’ŒSurvivoråŒºåŸŸæ¯”é‡ï¼Œæ³¨æ„æ˜¯ä¸€ä¸ªSurvivorçš„å¤§å°ï¼Œå¦‚æœå°†å…¶è®¾ç½®ä¸º8ï¼Œåˆ™è¯´æ˜EdenåŒºæ˜¯ä¸€ä¸ªSurvivoråŒºçš„8å€ï¼Œæ¢å¥è¯è¯´S0æˆ–S1ç©ºé—´æ˜¯æ•´ä¸ªYoungç©ºé—´çš„1/10ï¼Œå‰©ä½™çš„80%ç”±EdenåŒºåŸŸæ¥ä½¿ç”¨ã€‚
ç¬¬äºŒä¸ªå‚æ•°æ˜¯Young/S0çš„æ¯”å€¼ï¼Œå½“å…¶è®¾ç½®ä¸º8æ—¶ï¼Œè¡¨ç¤ºs0æˆ–s1å æ•´ä¸ªYoungç©ºé—´çš„12.5%ã€‚

é—®é¢˜äº”ï¼›ä¸€ä¸ªå¯¹è±¡æ¯æ¬¡Minor Gcæ—¶ï¼Œæ´»ç€çš„å¯¹è±¡éƒ½ä¼šåœ¨s0å’Œs1åŒºåŸŸè½¬ç§»ï¼Œç»è¿‡ç»è¿‡Minor GCå¤šå°‘æ¬¡åï¼Œä¼šè¿›å…¥OldåŒºåŸŸå‘¢ï¼Ÿ
é»˜è®¤æ˜¯15æ¬¡ï¼Œå‚æ•°è®¾ç½®-XX:MaxTenuringThreshold=15,è®¡æ•°å™¨ä¼šåœ¨å¯¹è±¡çš„å¤´éƒ¨è®°å½•å®ƒäº¤æ¢çš„æ¬¡æ•°

é—®é¢˜å…­ï¼šä¸ºä»€ä¹ˆå‘ç”ŸFULL GCä¼šå¸¦æ¥å¾ˆå¤§çš„å±å®³ï¼Ÿ
åœ¨å‘ç”ŸFULL GCçš„æ—¶å€™ï¼Œæ„å‘³ç€JVMä¼šå®‰å…¨çš„æš‚åœæ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼ˆStop The Worldï¼‰ï¼Œæ¥å›æ”¶å†…å­˜ç©ºé—´ï¼Œåœ¨è¿™ä¸ªæ—¶é—´æ®µå†…ï¼Œæ‰€æœ‰é™¤äº†å›æ”¶åƒåœ¾çš„çº¿ç¨‹å¤–ï¼Œå…¶ä»–æœ‰å…³JAVAçš„ç¨‹åºï¼Œä»£ç éƒ½ä¼šé™æ­¢ï¼Œåæ˜ åˆ°ç³»ç»Ÿä¸Šï¼Œå°±ä¼šå‡ºç°ç³»ç»Ÿå“åº”å¤§å¹…åº¦å˜æ…¢ï¼Œå¡æœºç­‰çŠ¶æ€ã€‚

ä¸¾ä¸ªé€šä¿—æ˜“æ‡‚ç‚¹çš„ä¾‹å­ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ªæˆ¿é—´é‡Œï¼Œå¦‚æœæœ‰ä¸€ä¸ªäººï¼Œä¸åœçš„æ‰”åƒåœ¾ï¼Œç„¶åæœ‰ä¸€ä¸ªæ¸…æ´å·¥ä¸åœæ‰«åƒåœ¾ï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯OKçš„ï¼Œå› ä¸ºåŸºæœ¬ä¸ä¼šå‡ºç°åƒåœ¾å †æ»¡æˆ¿é—´çš„æƒ…æ™¯ï¼Œè€Œä¸”å› ä¸ºæ¸…æ´å·¥å¯ä»¥å¯¹ä»˜è¿‡æ¥ï¼Œå‡è®¾ç°åœ¨æœ‰10ä¸ªäººä¸åœæ‰”åƒåœ¾ï¼Œé‚£ä¹ˆå°±æˆ¿é—´å°±ä¼šå¾ˆå¿«è¢«å †æ»¡ï¼Œè¿™æ—¶å€™æ¸…æ´å·¥ï¼Œç”±äºå·¥ä½œä¸è¿‡æ¥äº†ï¼Œå¤§å£° å¼ä¸€å£°ï¼Œä½ ä»¬éƒ½æš‚åœ3åˆ†é’Ÿï¼Œåˆ«å†æ‰”äº†ï¼Œæˆ‘å…ˆæŠŠè¿™ä¸ªæˆ¿é—´æ‰“æ‰«å®Œï¼Œä½ ä»¬æ‰å¯ä»¥æ‰”ã€‚

åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œä¸€ä¸ªäººæ‰”ï¼Œä¸€ä¸ªäººæ‰«ï¼Œå°±ç±»ä¼¼äºMinor GCï¼Œè¿™æ—¶å€™ï¼Œå¹¶ä¸ä¼šå½±å“æ‰”åƒåœ¾çš„äººï¼Œç„¶åä¸€æ—¦10ä¸ªäººåŒæ—¶ä»ï¼Œè€Œä¸”å¾ˆå¿«å°±æ²¡åœ°æ–¹ä»äº†ï¼Œè¿™æ—¶å€™ï¼Œå°±ä¼šè§¦å‘Full GCï¼Œç„¶åJVMä¸‹ä»¤ï¼Œä½ ä»¬æš‚æ—¶éƒ½åˆ«ä»äº†ï¼Œç­‰æˆ‘ä»€ä¹ˆæ—¶å€™å›æ”¶å®Œåƒåœ¾äº†ï¼Œä½ ä»¬åœ¨ä»ï¼Œç°åœ¨å¤§å®¶æ¸…æ¥šäº†å§ï¼Œæ‰€è°“çš„10ä¸ªäººï¼Œå°±æ˜¯ç±»ä¼¼æˆ‘ä»¬æˆåƒä¸Šç™¾çš„javaç±»ï¼Œ åœ¨ä¸åœçš„æ‰§è¡Œä»»åŠ¡ï¼Œæ‰€è°“çš„æ¸…æ´å·¥ï¼Œå°±æ˜¯æˆ‘ä»¬çš„GCæœºåˆ¶ï¼Œæ‰€ä»¥ï¼Œå¤§å®¶åœ¨å¹³æ—¶ç¼–ç çš„æ—¶å€™ï¼Œä¸€å®šæ³¨æ„å°½é‡å°‘é€ ç‚¹åƒåœ¾å¯¹è±¡ï¼Œè¿™æ ·è§¦å‘FULL GCçš„å‡ ç‡ï¼Œæ‰ä¼šå˜å°ã€‚
```

å †çš„å¤§å°æ—¢å¯ä»¥å›ºå®šä¹Ÿå¯ä»¥æ‰©å±•ï¼Œä½†å¯¹äºä¸»æµçš„è™šæ‹Ÿæœºï¼Œå †çš„å¤§å°æ˜¯å¯æ‰©å±•çš„ï¼ˆé€šè¿‡-Xmxå’Œ-Xmsæ§åˆ¶ï¼‰ï¼Œå› æ­¤ å½“çº¿ç¨‹è¯·æ±‚åˆ†é…å†…å­˜ï¼Œä½†å †å·²æ»¡ï¼Œä¸”å†…å­˜å·²æ— æ³•å†æ‰©å±•æ—¶ï¼Œå°±æŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚

> Java å †æ‰€ä½¿ç”¨çš„å†…å­˜ä¸éœ€è¦ä¿è¯æ˜¯è¿ç»­çš„ï¼ˆç‰©ç†å†…å­˜ä¸è¿ç»­ï¼Œä½†æ˜¯é€»è¾‘å†…å­˜è¦è¿ç»­ï¼‰ã€‚è€Œç”±äºå †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ï¼Œæ‰€ä»¥å¯¹å®ƒçš„è®¿é—®éœ€è¦æ³¨æ„åŒæ­¥é—®é¢˜ï¼Œæ–¹æ³•å’Œå¯¹åº”çš„å±æ€§éƒ½éœ€è¦ä¿è¯ä¸€è‡´æ€§ã€‚

## æ–¹æ³•åŒº

### æ–¹æ³•åŒºçš„å®šä¹‰

Java è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰æ˜¯å †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ã€‚æ–¹æ³•åŒºå­˜æ”¾ä»¥ä¸‹ä¿¡æ¯ï¼š  


* å·²ç»è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ï¼ˆå¦‚ï¼šç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ï¼‰
* å¸¸é‡
* é™æ€å˜é‡
* å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç 

### æ–¹æ³•åŒºçš„ç‰¹ç‚¹

* ==çº¿ç¨‹å…±äº«==ã€‚  javaè™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå«Non-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„åº”è¯¥æ˜¯å’Œjavaå †åŒºåˆ†å¼€æ¥ã€‚å®ƒæ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œæ•´ä¸ªè™šæ‹Ÿæœºä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•åŒºã€‚
* æ°¸ä¹…ä»£ï¼ˆjdk1.8æ°¸ä¹…ä»£è¢«å…ƒç©ºé—´MetaSpaceå–ä»£ï¼‰ã€‚  æ–¹æ³•åŒºä¸­çš„ä¿¡æ¯ä¸€èˆ¬éœ€è¦é•¿æœŸå­˜åœ¨ï¼Œè€Œä¸”å®ƒåˆæ˜¯å †çš„é€»è¾‘åˆ†åŒºï¼Œå› æ­¤ç”¨å †çš„åˆ’åˆ†æ–¹æ³•ï¼Œ<u>æŠŠæ–¹æ³•åŒºç§°ä¸ºâ€œæ°¸ä¹…ä»£â€ï¼ˆé’ˆå¯¹äºHotSpotè€Œè¨€ï¼Œä½†å†Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å¹¶ä¸å­˜åœ¨è¿™ä¸€è¯´æ³•ï¼ï¼ï¼ï¼‰</u>ã€‚
* å†…å­˜å›æ”¶æ•ˆç‡ä½ã€‚  æ–¹æ³•åŒºä¸­çš„ä¿¡æ¯ä¸€èˆ¬éœ€è¦é•¿æœŸå­˜åœ¨ï¼Œå›æ”¶ä¸€éä¹‹åå¯èƒ½åªæœ‰å°‘é‡ä¿¡æ¯æ— æ•ˆã€‚ä¸»è¦å›æ”¶ç›®æ ‡æ˜¯ï¼šå¯¹å¸¸é‡æ± çš„å›æ”¶ï¼›å¯¹ç±»å‹çš„å¸è½½ã€‚
* Java è™šæ‹Ÿæœºè§„èŒƒå¯¹æ–¹æ³•åŒºçš„è¦æ±‚æ¯”è¾ƒå®½æ¾ã€‚  å’Œå †ä¸€æ ·ï¼Œå…è®¸å›ºå®šå¤§å°ï¼Œä¹Ÿå…è®¸åŠ¨æ€æ‰©å±•ï¼Œè¿˜å…è®¸ä¸å®ç°åƒåœ¾å›æ”¶ã€‚
* å¼‚å¸¸çš„å®šä¹‰
* åŒæ ·ä¼šæŠ›å‡ºOutOfMemoryErroe

### è¿è¡Œæ—¶å¸¸é‡æ± (å­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­)

æ–¹æ³•åŒºä¸­å­˜æ”¾ï¼šç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ã€‚å¸¸é‡å°±å­˜æ”¾åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚

å½“ç±»è¢« Java è™šæ‹ŸæœºåŠ è½½åï¼Œ .class æ–‡ä»¶ä¸­çš„å¸¸é‡å°±å­˜æ”¾åœ¨æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚è€Œä¸”åœ¨è¿è¡ŒæœŸé—´ï¼Œå¯ä»¥å‘å¸¸é‡æ± ä¸­æ·»åŠ æ–°çš„å¸¸é‡ã€‚å¦‚ String ç±»çš„ intern\(\) æ–¹æ³•å°±èƒ½åœ¨è¿è¡ŒæœŸé—´å‘å¸¸é‡æ± ä¸­æ·»åŠ å­—ç¬¦ä¸²å¸¸é‡ã€‚

```java
public static void main(String[] args) {
    String s1 = "abc";
    String s2 = "abc";
    // æ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½å­˜æ”¾åœ¨å¸¸é‡æ± ä¸­
    System.out.pringln(s1 == s2); // true
    
    // ä½¿ç”¨newåˆ›å»ºçš„å¯¹è±¡éƒ½å­˜æ”¾åœ¨å †ä¸­
    String s3 = new String("abc");
    System.out.pringln(s1 == s3); // false
    
    // Stringçš„intern()æ–¹æ³•ï¼ˆæ˜¯ä¸€ä¸ªNativeæ–¹æ³•ï¼‰ï¼Œä¼šå°†newå‡ºæ¥çš„å¯¹è±¡ï¼ˆå­—ç¬¦ä¸²ï¼‰æ”¾åˆ°å¸¸é‡æ± ä¸­å»
    // s3.intern()å°±æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶å¸¸é‡
    System.out.pringln(s1 == s3.intern()); // true
}
```

- å½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶åŒæ ·ä¼šæŠ›å‡ºOutOfMemoryErroe

## ç›´æ¥å†…å­˜ï¼ˆå †å¤–å†…å­˜ï¼‰

ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸï¼Œä½†è¿™ä¸€éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹çš„ä½¿ç”¨ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´OutOfMemoryErroeã€‚

### æ“ä½œç›´æ¥å†…å­˜

åœ¨ NIO ä¸­å¼•å…¥äº†ä¸€ç§åŸºäºé€šé“å’Œç¼“å†²çš„ IO æ–¹å¼ã€‚å®ƒå¯ä»¥é€šè¿‡è°ƒç”¨æœ¬åœ°æ–¹æ³•ç›´æ¥åˆ†é… Java è™šæ‹Ÿæœºä¹‹å¤–çš„å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨å †ä¸­çš„`DirectByteBuffer`å¯¹è±¡ç›´æ¥æ“ä½œè¯¥å†…å­˜ï¼Œè€Œæ— é¡»å…ˆå°†å¤–éƒ¨å†…å­˜ä¸­çš„æ•°æ®å¤åˆ¶åˆ°å †ä¸­å†è¿›è¡Œæ“ä½œï¼Œä»è€Œæé«˜äº†æ•°æ®æ“ä½œçš„æ•ˆç‡ã€‚

ç›´æ¥å†…å­˜çš„å¤§å°ä¸å— Java è™šæ‹Ÿæœºæ§åˆ¶ï¼Œä½†æ—¢ç„¶æ˜¯å†…å­˜ï¼Œå½“å†…å­˜ä¸è¶³æ—¶å°±ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚

### ç›´æ¥å†…å­˜ä¸å †å†…å­˜æ¯”è¾ƒ

* ç›´æ¥å†…å­˜ç”³è¯·ç©ºé—´è€—è´¹æ›´é«˜çš„æ€§èƒ½
* ç›´æ¥å†…å­˜è¯»å– IO çš„æ€§èƒ½è¦ä¼˜äºæ™®é€šçš„å †å†…å­˜ã€‚
* ç›´æ¥å†…å­˜ä½œç”¨é“¾ï¼š æœ¬åœ° IO -&gt; ç›´æ¥å†…å­˜ -&gt; æœ¬åœ° IO
* å †å†…å­˜ä½œç”¨é“¾ï¼šæœ¬åœ° IO -&gt; ç›´æ¥å†…å­˜ -&gt; éç›´æ¥å†…å­˜ -&gt; ç›´æ¥å†…å­˜ -&gt; æœ¬åœ° IO

> æœåŠ¡å™¨ç®¡ç†å‘˜åœ¨é…ç½®è™šæ‹Ÿæœºå‚æ•°æ—¶ï¼Œä¼šæ ¹æ®å®é™…å†…å­˜è®¾ç½®`-Xmx`ç­‰å‚æ•°ä¿¡æ¯ï¼Œä½†ç»å¸¸å¿½ç•¥ç›´æ¥å†…å­˜ï¼Œä½¿å¾—å„ä¸ªå†…å­˜åŒºåŸŸæ€»å’Œå¤§äºç‰©ç†å†…å­˜é™åˆ¶ï¼Œä»è€Œå¯¼è‡´åŠ¨æ€æ‰©å±•æ—¶å‡ºç°`OutOfMemoryError`å¼‚å¸¸ã€‚



## Javaå †æº¢å‡ºã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡ºï¼š

## å †æº¢å‡ºï¼šOOMï¼ˆOutOfMemoryErrorï¼‰

è®¾ç½®å‚æ•°VM optionsï¼š-verbose:gc -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8

- -verbose:gc ï¼š å¼€å¯gcæ—¥å¿—
- -Xms20Mï¼šå †çš„æœ€å°å€¼
- -Xmx20Mï¼šå †çš„æœ€å¤§å€¼ï¼ˆ-Xms20Må’Œ-Xmx20Mçš„å€¼ä¸€æ ·å¤§æ—¶ï¼Œå¯ä»¥é¿å…å †è‡ªåŠ¨æ‰©å±•ï¼‰
- -Xmn10Mï¼š æ–°ç”Ÿä»£å¤§å°
- -XX:+PrintGCDetails ï¼š æ‰“å°gcè¯¦æƒ…
- -XX:+PrintGCDateStamps ï¼š æ‰“å°gcæ—¶é—´æˆ³
- -Xloggc:gcc.log ï¼š å°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶xx(é»˜è®¤ä½ç½®ä¸ºæ¡Œé¢)
- -XX:+HeapDumpOnOutOfMemoryErrorï¼šè®©è™šæ‹Ÿæœºåœ¨å‡ºç°å†…å­˜æº¢å‡ºå¼‚å¸¸æ—¶Dumpå‡ºå½“å‰çš„å†…å­˜å †è½¬å‚¨å¿«ç…§

```JAVA
/**
 * VM optionsï¼š-verbose:gc -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8
 */
public static void main(String[] args) {
        List<OOMObject> list = new ArrayList<>();
        while (true) {
            list.add(new OOMObject());
        }
    }

    static class OOMObject {

    }

ç»“æœï¼š
[GC (Allocation Failure) [PSYoungGen: 8161K->1009K(9216K)] 8161K->4510K(19456K), 0.0282552 secs] [Times: user=0.00 sys=0.00, real=0.05 secs] 
[GC (Allocation Failure) [PSYoungGen: 9201K->1024K(9216K)] 12702K->9747K(19456K), 0.0107310 secs] [Times: user=0.06 sys=0.00, real=0.01 secs] 
[Full GC (Ergonomics) [PSYoungGen: 1024K->0K(9216K)] [ParOldGen: 8723K->9634K(10240K)] 9747K->9634K(19456K), [Metaspace: 3487K->3487K(1056768K)], 0.1216263 secs] [Times: user=0.24 sys=0.00, real=0.12 secs] 
[Full GC (Ergonomics) [PSYoungGen: 8192K->6143K(9216K)] [ParOldGen: 9634K->9355K(10240K)] 17826K->15498K(19456K), [Metaspace: 3489K->3489K(1056768K)], 0.1634631 secs] [Times: user=0.64 sys=0.00, real=0.16 secs] 
[Full GC (Ergonomics) [PSYoungGen: 7756K->7541K(9216K)] [ParOldGen: 9355K->9344K(10240K)] 17111K->16885K(19456K), [Metaspace: 3489K->3489K(1056768K)], 0.1244273 secs] [Times: user=0.72 sys=0.02, real=0.13 secs] 
[Full GC (Allocation Failure) [PSYoungGen: 7541K->7541K(9216K)] [ParOldGen: 9344K->9326K(10240K)] 16885K->16867K(19456K), [Metaspace: 3489K->3489K(1056768K)], 0.1262223 secs] [Times: user=0.58 sys=0.01, real=0.13 secs] 
Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
	at java.util.Arrays.copyOf(Arrays.java:3210)
	at java.util.Arrays.copyOf(Arrays.java:3181)
	at java.util.ArrayList.grow(ArrayList.java:265)
	at java.util.ArrayList.ensureExplicitCapacity(ArrayList.java:239)
	at java.util.ArrayList.ensureCapacityInternal(ArrayList.java:231)
	at java.util.ArrayList.add(ArrayList.java:462)
	at com.xwl.prisonbreak.util.poiExcel.test.Test2.main(Test2.java:16)
Heap
 PSYoungGen      total 9216K, used 7737K [0x00000000ff600000, 0x0000000100000000, 0x0000000100000000)
  eden space 8192K, 94% used [0x00000000ff600000,0x00000000ffd8e728,0x00000000ffe00000)
  from space 1024K, 0% used [0x00000000fff00000,0x00000000fff00000,0x0000000100000000)
  to   space 1024K, 0% used [0x00000000ffe00000,0x00000000ffe00000,0x00000000fff00000)
 ParOldGen       total 10240K, used 9326K [0x00000000fec00000, 0x00000000ff600000, 0x00000000ff600000)
  object space 10240K, 91% used [0x00000000fec00000,0x00000000ff51b940,0x00000000ff600000)
 Metaspace       used 3520K, capacity 4500K, committed 4864K, reserved 1056768K
  class space    used 379K, capacity 388K, committed 512K, reserved 1048576K
```



## æ ˆæº¢å‡ºï¼šStackOverFlowError

å…³äºè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œåœ¨javaè™šæ‹Ÿæœºè§„èŒƒä¸­æè¿°äº†ä¸¤ç§å¼‚å¸¸ï¼š

- å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ ˆæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦ï¼Œå°†StackOverFlowErrorå¼‚å¸¸ã€‚
- å¦‚æœè™šæ‹Ÿæœºæ ˆåœ¨æ‰©å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´åˆ™æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚

```java
public static void main(String[] args) {
        method();
    }

    public static void method() {
        method();
    }

ç»“æœï¼šException in thread "main" java.lang.StackOverflowError
	at com.xwl.prisonbreak.util.poiExcel.test.Test2.method(Test2.java:14)
	at com.xwl.prisonbreak.util.poiExcel.test.Test2.method(Test2.java:14)
	at com.xwl.prisonbreak.util.poiExcel.test.Test2.method(Test2.java:14)
    ã€‚ã€‚ã€‚
```



ï¼ˆå®Œï¼‰
---

ğŸ‘‰ [Previous](../README.md)<br>
ğŸ‘‰ [Next](/docs/02-hotspot-jvm-object.md)<br>
ğŸ‘‰ [Back to README](../README.md)